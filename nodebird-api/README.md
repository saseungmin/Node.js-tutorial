# âœ” ì›¹ API ì„œë²„ ë§Œë“¤ê¸°
- API(Application Programming Interface)ë¡œ ë‹¤ë¥¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ í˜„ì¬ í”„ë¡œê·¸ë¨ì˜ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í—ˆìš©í•˜ëŠ” ì ‘ì ì„ ì˜ë¯¸í•œë‹¤.
## ğŸŒˆ í”„ë¡œì íŠ¸ ì„¤ì •
- `package.json` ì„¤ì • (`npm install`)
<pre>
  "dependencies": {
    "bcrypt": "^5.0.0",
    "connect-flash": "^0.1.1",
    "cookie-parser": "^1.4.5",
    "dotenv": "^8.2.0",
    "express": "^4.17.1",
    "express-session": "^1.17.1",
    "morgan": "^1.10.0",
    "mysql2": "^2.1.0",
    "passport": "^0.4.1",
    "passport-kakao": "^1.0.0",
    "passport-local": "^1.0.0",
    "pug": "^3.0.0",
    "sequelize": "^6.1.0",
    "uuid": "^8.2.0"
  },
  "devDependencies": {
    "nodemon": "^2.0.4"
  }
</pre>
- `domain.js` ì‘ì„± í›„ `model/index.js` ìˆ˜ì •
- `view/login.pug` ì‘ì„±
- ë„ë©”ì¸ì„ ë“±ë¡í•˜ëŠ” ì´ìœ ëŠ” ë“±ë¡í•œ ë„ë©”ì¸ì—ì„œë§Œ APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•˜ê¸° ìœ„í•´ì„œì´ë‹¤.
- ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ìš”ì²­ì„ ë³´ë‚¼ ë•Œ, ì‘ë‹µí•˜ëŠ” ê³³ê³¼ ë„ë©”ì¸ì´ ë‹¤ë¥´ë©´ CORS(Cross-Origin Resource Sharing) ì—ëŸ¬ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
- ë¬´ë£Œì™€ í”„ë¦¬ë¯¸ì—„ì€ ì‚¬ìš©ëŸ‰ ì œí•œ.
- í´ë¼ì´ì–¸íŠ¸ ë¹„ë°€í‚¤ëŠ” ë‹¤ë¥¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¸ì¦ ìš©ë„ë¡œ ì‚¬ìš©í•œë‹¤.

![img](./img/1.PNG)

<hr>

## ğŸŒˆ JWT í† í° ì¸ì¦
> ì°¸ê³  ë§í¬ : https://jwt.io/introduction/
- JWT(*JSON Web Token*)ì€ JSON í˜•ì‹ì˜ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” í† í°ì´ë‹¤.
- JWTëŠ” ì„¸ ë¶€ë¶„ìœ¼ë¡œ êµ¬ì„±ëœë‹¤.
> - í—¤ë” : í† í° ì¢…ë¥˜ì™€ í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ ì •ë³´ê°€ ë“¤ì–´ìˆë‹¤.
> - í˜ì´ë¡œë“œ : í† í°ì˜ ë‚´ìš©ë¬¼ì´ ì¸ì½”ë”©ëœ ë¶€ë¶„ì´ë‹¤.
> - ì‹œê·¸ë‹ˆì²˜ : ì¼ë ¨ì˜ ë¬¸ìì—´ë¡œ, ì‹œê·¸ë‹ˆì²˜ë¥¼ í†µí•´ í† í°ì´ ë³€ì¡°ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
- JWTëŠ” ë‚´ìš©ì„ ë³¼ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ë¯¼ê°í•œ ë‚´ìš©ì„ ë„£ìœ¼ë©´ ì•ˆ ëœë‹¤.
- JWT í† í°ì€ JWT ë¹„ë°€í‚¤ë¥¼ ì•Œì§€ ì•ŠëŠ” ì´ìƒ ë³€ì¡°ê°€ ë¶ˆê°€ëŠ¥í•˜ë‹¤.
- ë‹¨ì ì€ ë‚´ìš©ë¬¼ì´ ë“¤ì–´ ìˆê¸° ë•Œë¬¸ì— ìš©ëŸ‰ì´ í¬ë‹¤.
#### ğŸ”¸ JWT ëª¨ë“ˆ ì„¤ì¹˜
<pre>
$ npm i jsonwebtoken
</pre>
- `.env`ì— `JWT_SECRET=[jwt í† í° ë¹„ë°€í‚¤]` ì¶”ê°€
- `routes/middleware.js`
- ìš”ì²­ í—¤ë”ì— ì €ì¥ëœ í† í°(`req.headers.authorization`)ì„ ì‚¬ìš©í•˜ê³  `jwt.verify` ë©”ì„œë“œë¡œ í† í°ì„ ê²€ì¦í•  ìˆ˜ ìˆë‹¤.
- ì²«ë²ˆì§¸ ì¸ìë¡œ í† í°ì„ ë‘ë²ˆì§¸ ì¸ìë¡œëŠ” í† í°ì˜ ë¹„ë°€í‚¤ë¥¼ ë„£ì–´ì¤€ë‹¤.
<pre>
req.decoded = jwt.verify(req.headers.authorization, process.env.JWT_SECRET);
</pre>
- `routes/v1.js` 
<pre>
    // í† í° ìƒì„±
    const token = jwt.sign(
      {
        id: domain.user.id, // ì‚¬ìš©ì ì•„ì´ë””
        nick: domain.user.nick, // ë‹‰ë„¤ì„
      },
      process.env.JWT_SECRET, //í† í° ë¹„ë°€í‚¤
      {
        expiresIn: '1m', // 1ë¶„ (ìœ íš¨ê¸°ê°„)
        issuer: 'seungmin', // ë°œê¸‰ì
      },
    );
</pre>
- v1 ì´ë¼ê³  ì§€ì€ ì´ìœ ëŠ” ë‹¤ë¥¸ ì‚¬ëŒì´ ê¸°ì¡´ APIë¥¼ ì“°ê³  ìˆê¸° ë•Œë¬¸ì— ë¼ìš°í„°ë¥¼ í•¨ë¶€ë¡œ ìˆ˜ì •í•˜ë©´ ì•ˆëœë‹¤.
- `jwt.sign` ë©”ì„œë“œë¡œ í† í°ì„ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆë‹¤.
> - `jwt.sign`ì˜ ì²« ë²ˆì§¸ ì¸ìëŠ” í† í°ì˜ ë‚´ìš©ì´ë‹¤.(ì‚¬ìš©ì ì•„ì´ë””ì™€ ë‹‰ë„¤ì„)
> - ë‘ ë²ˆì§¸ ì¸ìëŠ” í† í°ì˜ ë¹„ë°€í‚¤ë¡œ ìœ ì¶œë˜ë©´ í† í°ì„ ì„ì˜ë¡œ ìƒì„±ê°€ëŠ¥í•˜ë‹¤.
> - ì„¸ ë²ˆì§¸ ì¸ìëŠ” í† í°ì˜ ì„¤ì •ìœ¼ë¡œ ìœ íš¨ê¸°ê°„ì„ 1ë¶„, ë°œê¸‰ìë¥¼ ì •í•´ì£¼ì—ˆë‹¤. (1ë¶„ = 60 * 1000)
- GET /v1/test ë¼ìš°í„°ëŠ” ì‚¬ìš©ìê°€ ë°œê¸‰ë°›ì€ í† í°ì„ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë¼ìš°í„°ë¡œ í† í° ê²€ì¦ ë¯¸ë“¤ì›¨ì–´ë¥¼ ê±°ì¹œë‹¤.
<pre>
router.get('/test', verifyToken, (req, res) => {
  res.json(req.decoded);
});
</pre>
- ë¼ìš°í„° ì„œë²„ì— ì—°ê²°
<pre>
// app.js
const v1 = require('./routes/v1');
app.use('/v1', v1);
</pre>

## ğŸŒˆ ì‚¬ìš©ëŸ‰ ì œí•œ êµ¬í˜„
<pre>
$ npm i express-rate-limit
</pre>
- `routes/middlewares.js`ì— `apiLimiter` ë¼ìš°í„° ì¶”ê°€í•œë‹¤.
<pre>
const RateLimit = require('express-rate-limit');

exports.apiLimiter = new RateLimit({
  windowMs: 60 * 1000, // 1ë¶„ (ê¸°ì¤€ ì‹œê°„)
  max: 10, // í—ˆìš© íšŸìˆ˜
  delayMs: 0, // í˜¸ì¶œ ê°„ê²©
  handler(req, res) { // ì œí•œ ì´ˆê³¼ ì‹œ ì½œë°± í•¨ìˆ˜ (429)
    res.status(this.statusCode).json({
      code: this.statusCode, // ê¸°ë³¸ê°’ : 429
      message: '1ë¶„ì— ì—´ ë²ˆë§Œ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
    });
  },
});
</pre>
- `routes/middlewares.js`ì— `deprecated` ë¼ìš°í„° ì¶”ê°€í•˜ì—¬ ë²„ì „ì´ ì§€ë‚œ `v1`ë¼ìš°í„°ë¥¼ ì‚¬ìš©í•˜ë©´ ìƒˆë¡œìš´ ë²„ì „ì„ ì‚¬ìš©í•˜ë¼ê³  ì•Œë ¤ì£¼ëŠ” ë¼ìš°í„°ì´ë‹¤.
<pre>
// ì‚¬ìš©í•˜ë©´ ì•ˆë˜ëŠ” ë¼ìš°í„°ì— ë¶™ì—¬ì¤€ë‹¤.
exports.deprecated = (req, res) => {
  res.status(410).json({
    code: 410, // ìƒˆ ë²„ì „
    message: 'ìƒˆë¡œìš´ ë²„ì „ì´ ë‚˜ì™”ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ë²„ì „ì„ ì‚¬ìš©í•˜ì„¸ìš”.',
  });
};
</pre>
- ìƒˆë¡œìš´ ë²„ì „ìœ¼ë¡œ `v2` ë¼ìš°í„°ë¥¼ ìƒì„±í•˜ì—¬ `apiLimiter` ë¼ìš°í„°ë¥¼ ë¯¸ë“¤ì›¨ì–´ë¡œ ì¶”ê°€í•´ì¤€ë‹¤.
- `v1`ë¼ìš°í„°ëŠ” `deprecated`ë¼ìš°í„°ë¥¼ ì¶”ê°€í•´ì¤€ë‹¤.
<pre>
// v1 ë¼ìš°í„° ì‚¬ìš©ì‹œ ê²½ê³  ë©”ì‹œì§€ ì¶œë ¥
router.use(deprecated);
</pre>
- `app.js`ì— `v2`ë¼ìš°í„°ë¥¼ ì„œë²„ì™€ ì—°ê²°í•œë‹¤.

- 1ë¶„ì— 10ë²ˆ ìš”ì²­ ì´ˆê³¼ì‹œ

![ì´ˆê³¼](./img/3.PNG)

- `v1`ìœ¼ë¡œ ìš”ì²­ ì‹œ

![ww](./img/4.PNG)

## ğŸŒˆ [SNS API í˜¸ì¶œ ì„œë²„](https://github.com/saseungmin/Node.js-tutorial/tree/master/nodebird-call#-sns-api-%ED%98%B8%EC%B6%9C-%EC%84%9C%EB%B2%84)

## ğŸŒˆ [CORS ì´í•´í•˜ê¸°](https://github.com/saseungmin/Node.js-tutorial/tree/master/nodebird-call#-cors-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0)

### ğŸ“Œ ì¶”ê°€ ê¸°ëŠ¥ êµ¬í˜„í•´ë³´ê¸°
- íŒ”ë¡œì›Œë‚˜ íŒ”ë¡œì‰ ëª©ë¡ ê°€ì ¸ì˜¤ëŠ” API ë§Œë“¤ê¸°
- ë¬´ë£Œì¸ ë„ë©”ì¸ê³¼ í”„ë¦¬ë¯¸ì–´ ë„ë©”ì¸ ê°„ ì‚¬ìš©ëŸ‰ ì œí•œ ë‹¤ë¥´ê²Œ ì ìš©í•˜ê¸°
- í´ë¼ì´ì–¸íŠ¸ìš©ê³¼ ì„œë²„ìš© ë¹„ë°€í‚¤ë¥¼ êµ¬ë¶„í•´ì„œ ë°œê¸‰í•˜ê¸°
- í´ë¼ì´ì–¸íŠ¸ë¥¼ ìœ„í•´ APIë¬¸ì„œ ì‘ì„±í•˜ê¸°